services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: safety-index-api
    ports:
      - "8000:8000"
    environment:
      # Project settings
      - PROJECT_NAME=${PROJECT_NAME:-Traffic Safety API}
      - VERSION=${VERSION:-0.1.0}
      - DEBUG=${DEBUG:-true}
      - BASE_URL=${BASE_URL:-http://localhost:8000}

      # Trino connection
      - TRINO_HOST=${TRINO_HOST:-smart-cities-trino.pre-prod.cloud.vtti.vt.edu}
      - TRINO_PORT=${TRINO_PORT:-443}
      - TRINO_HTTP_SCHEME=${TRINO_HTTP_SCHEME:-https}
      - TRINO_CATALOG=${TRINO_CATALOG:-smartcities_iceberg}

      # Safety Index settings
      - EMPIRICAL_BAYES_K=${EMPIRICAL_BAYES_K:-50}
      - DEFAULT_LOOKBACK_DAYS=${DEFAULT_LOOKBACK_DAYS:-7}

      # VCC API configuration
      - VCC_BASE_URL=${VCC_BASE_URL:-https://vcc.vtti.vt.edu}
      - VCC_CLIENT_ID=${VCC_CLIENT_ID:-}
      - VCC_CLIENT_SECRET=${VCC_CLIENT_SECRET:-}
      - DATA_SOURCE=${DATA_SOURCE:-trino}
      - PARQUET_STORAGE_PATH=${PARQUET_STORAGE_PATH:-backend/data/parquet}
      - REALTIME_ENABLED=${REALTIME_ENABLED:-false}
    env_file:
      - .env
    volumes:
      # Mount app directory for development (optional - comment out for production)
      - ./app:/app/app
      # Mount Trino OAuth token cache (Windows path - adjust for your OS)
      # For Windows: C:\Users\YourUsername\.trino
      # For Linux/Mac: ~/.trino
      - ${USERPROFILE}/.trino:/root/.trino
      # Mount Parquet storage directory
      - ./data/parquet:/app/backend/data/parquet
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
